prep_install_desktop(){
    echo "${GREEN}I: Installing the GNOME (Flashback) Metapackage, (NOTE: This is still experimental so consider it as unstable for now)${NOATTR}"
    sudo apt install gnome-session-flashback metacity gnome-terminal feh nautilus tigervnc-standalone-server tigervnc-xorg-extension xsetroot firefox xterm gnome-panel dbus-x11 lxappearance -yy || :
}

prep_install_desktop

echo "${GREEN}I: Doing Pending Configuration${NOATTR}"
sudo dpkg --configure -a

# Check if dependencies installed (Base)
check_deps(){
for d in /usr/bin/{gnome-panel,metacity,feh,nautilus,xsetroot,tigervncserver,firefox,xterm,dbus-launch,gnome-terminal,lxappearance}; do test -e ${d}; done
}

if ! check_deps; then
    echo "${RED}W: An Error Has Occurred during the installation, please try again${NOATTR}"
    exit 2
fi

# Create Xstartup File
echo "${GREEN}I: Creating xstartup file${NOATTR}"
mkdir -p ~/.vnc
cat > ~/.vnc/xstartup <<- EOM
#!/bin/bash

gnome-panel &
metacity &
gnome-terminal &

if [ ! -e ~/.vnc_wallpaper_set_successful ]; then
    touch ~/.vnc_wallpaper_set_successful
    xsetroot -solid gray
fi
EOM


# Create Start Script
echo "${GREEN}I: Creating Start Script${NOATTR}"
cat > /usr/local/bin/gnome-session <<- EOM
#!/bin/bash

check_lock_files(){
    for l in /tmp/.X51-lock /tmp/.X11-unix/X51; do test -e "\${l}"; done
}

if check_lock_files; then
    echo "${RED}E: Another VNC Server is running at port 5951, Please Close it first${NOATTR}"
    exit 2
fi

echo "${GREEN}Starting VNC Server with Session: ${YELLOW}GNOME Flashback${NOATTR}"
echo "${GREEN}Running at port ${YELLOW}:51${NOATTR}"

if [ ! -e /var/debdroid/vnc-resolution ]; then
    set_resolution=\$(
        dialog --title "Setup VNC Resolution" \
            --inputbox "Enter your Resolution for your VNC Display (WxH), You can change settings later, you may leave it blank for defaults" 11 40 \
            3>&1 1>&2 2>&3 3>&-
    )

    if [ ! -z "\${set_resolution}" ]; then
        echo "\${set_resolution}" > /var/debdroid/vnc-resolution
    else
        echo "${GREEN}I: Using the Default Desired Resolution: ${YELLOW}1280x720${NOATTR}"
        echo "1280x720" > /var/debdroid/vnc-resolution
    fi
fi

echo "${GREEN}Running in the foreground. to terminate it hit Ctrl-C"
echo "However the safest option is to log-out from the Menu${NOATTR}"

tigervncserver -SecurityTypes none -xstartup ~/.vnc/xstartup -fg -autokill -geometry "\$(cat /var/debdroid/vnc-resolution)" -localhost no --I-KNOW-THIS-IS-INSECURE :51
EOM
chmod 755 /usr/local/bin/gnome-session

echo "${GREEN}I: Successfully Installed ${YELLOW}gnome-flashback${GREEN}, You can start the session by typing ${YELLOW}gnome-session${NOATTR}"
exit 0